"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[498],{9234:(e,t,n)=>{n.d(t,{Z:()=>s});var o=n(54568),a=n(7620);let s=(0,a.forwardRef)((e,t)=>{let{className:n,children:s,disabled:r,noDefaultScroll:i}=e,l=(0,a.useRef)(0),c=(0,a.useRef)(!0),d=(0,a.useRef)(null),u=(0,a.useCallback)(function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"auto";if(d.current&&c.current&&!(d.current.scrollHeight-d.current.clientHeight<d.current.scrollTop)&&d.current&&"function"==typeof d.current.scrollTo){var t,n,o;null==(o=d.current)||o.scrollTo({top:(null==(t=d.current)?void 0:t.scrollHeight)-(null==(n=d.current)?void 0:n.clientHeight)+5,behavior:e})}},[]),p=(0,a.useCallback)(e=>{if(d.current&&d.current&&"function"==typeof d.current.scrollTo){var t,n,o;d.current.style.overflow="hidden",null==(o=d.current)||o.scrollTo({top:(null==(t=d.current)?void 0:t.scrollHeight)*e-(null==(n=d.current)?void 0:n.clientHeight)/2,behavior:"auto"})}},[]),h=(0,a.useCallback)(()=>{d.current&&(d.current.style.overflow="")},[]);return(0,a.useImperativeHandle)(t,()=>({reset(){l.current=0,c.current=!0,i||u()},scrollToBottomIfPinned:u,scrollToPercentage:p,enableScrolling:h}),[u,p,h,i]),(0,a.useLayoutEffect)(()=>{r||!s||i||u()},[s,r,u,i]),(0,o.jsx)("div",{className:n,onScroll:e=>{if(r)return;let t=e.currentTarget.scrollTop,n=function(e,t){if(!e)return!1;{let n=e.scrollHeight-8;return Math.ceil(t+e.offsetHeight)>=Math.floor(n)}}(d.current,t),o=t>l.current;n&&o?c.current=!0:n||o||(c.current=!1),l.current=t},ref:d,children:s})});s.displayName="AutoScroll"},10498:(e,t,n)=>{n.d(t,{CodeRenderer:()=>k,k:()=>P,MarkdownRenderer:()=>O});var o=n(54568),a=n(56340),s=n(9946),r=n(74610),i=n(89697),l=n(9234),c=n(54890),d=n(92007),u=n(32987),p=n(7620),h=n(92479),m=n(47546),g=n(41417),f=n(91961),x=n(16566),y=n(24600),b=n(49645),C=n(37463),v=n(46760),S=n(62971);let w=e=>{let{isStreaming:t,children:n,...a}=e;return t?n:(0,o.jsx)(z,{...a,children:n})},z=e=>{let{children:t,sendMessage:n,contentType:a="text",isOpen:s}=e,r=(0,v.A)(),i=void 0!==n,[l,c]=(0,p.useState)([]),[d,h]=(0,p.useState)({top:0,left:0,width:0}),[w,z]=(0,p.useState)(!1),[R,q]=(0,p.useState)(!1),[M,j]=(0,p.useState)(""),[E,P]=(0,p.useState)(""),[k,O]=(0,p.useState)(!1),N=(0,p.useRef)(null),T=(0,p.useRef)(null),F=(0,p.useCallback)((e,t)=>{var n;let o=function(e,t){let n=[];for(let o=0;o<e.rangeCount;o++){let a=e.getRangeAt(o);if(a.startContainer===a.endContainer&&a.startContainer.nodeType===Node.TEXT_NODE){let e=a.startContainer,t=document.createRange();for(let o=a.startOffset;o<a.endOffset;o++){t.setStart(e,o),t.setEnd(e,o+1);let a=Array.from(t.getClientRects());n.push(...a)}t.detach()}else{let e=function(e){let t,n=[],o=document.createTreeWalker(e.commonAncestorContainer,NodeFilter.SHOW_TEXT,t=>e.intersectsNode(t)?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_REJECT);for(;t=o.nextNode();)n.push(t);return n}(a);e.forEach((o,s)=>{let r=document.createRange(),i="length"in o?o.length:0,l=0===s,c=s===e.length-1,d=l?a.startOffset:0,u=c&&!t?a.endOffset:i;r.setStart(o,d),r.setEnd(o,u);let p=Array.from(r.getClientRects());n.push(...p),r.detach()})}}return n}(e,t),a=null==(n=N.current)?void 0:n.getBoundingClientRect();return Array.from(o).map(e=>({top:e.top-((null==a?void 0:a.top)||0)-2.5,left:e.left-((null==a?void 0:a.left)||0),width:e.width,height:e.height+5.5}))},[]),A=(0,p.useCallback)(e=>{var t;let n=e.getRangeAt(0);return null==(t=N.current)?void 0:t.contains(n.commonAncestorContainer)},[]);(0,p.useEffect)(()=>{function e(e){var t,n,o,a;let s,r,{selection:i,isSelectAll:l}=e,d=F(i,l);if(d.every((e,t,n)=>0===t||5>Math.abs(e.top-n[0].top))){let e=Math.max(...d.map(e=>e.left+e.width));s=d[0].top-9,r=e+10}else{let e=Math.max(...d.map(e=>e.top+e.height));r=Math.min(...d.map(e=>e.left)),s=Math.min((null!=(o=null==(n=N.current)?void 0:n.scrollHeight)?o:0)-50,e)}let u=((null!=(a=null==(t=N.current)?void 0:t.scrollWidth)?a:1e3)-r)/3*2;c(d),z(!0),q(!1),h({top:s,left:r,width:u}),P(i.toString())}let t=()=>{O(!0)},n=t=>{"Escape"===t.key&&(q(!1),z(!1),j(""),c([]));let n=((0,f.cX)()?t.metaKey:t.ctrlKey)&&"a"===t.key,o=N.current;if(o&&s&&n){let n=document.activeElement&&(document.activeElement===o||(null==o?void 0:o.contains(document.activeElement))),a=window.getSelection();if(n&&a){t.preventDefault();let n=document.createRange();n.selectNodeContents(o),a.removeAllRanges(),a.addRange(n),e({selection:a,isSelectAll:!0})}}},o=t=>{if(T.current&&T.current.contains(t.target))return;let n=window.getSelection();n&&!n.isCollapsed&&A(n)?e({selection:n}):(c([]),z(!1),q(!1),P(""),j("")),O(!1)};return i&&(document.addEventListener("mousedown",t),document.addEventListener("mouseup",o),document.addEventListener("keydown",n)),()=>{document.removeEventListener("mousedown",t),document.removeEventListener("mouseup",o),document.removeEventListener("keydown",n)}},[F,A,i,s]);let I=e=>{i&&(n(e),j(""),q(!1),z(!1),c([]))},L=()=>"text"===a?E.split("\n").map(e=>"> ".concat(e)).join("\n"):"code"===a?"```\n".concat(E,"\n```"):void 0,U=()=>{I({prompt:"".concat(L(),"\n\n").concat(M),attachments:[],files:[],syncSources:[]})};return(0,o.jsxs)("div",{className:"w-full h-full relative",children:[(0,o.jsx)("div",{ref:N,tabIndex:0,className:(0,u.$)("w-full h-full relative",i?k?"[&_:not(input)::selection]:bg-secondary-000/10":"[&_*::selection]:bg-secondary-000/10":""),children:t}),l.map((e,t)=>(0,o.jsx)("div",{className:"absolute pointer-events-none bg-accent-secondary-000/10",style:{top:e.top,left:e.left,width:e.width,height:e.height}},t)),(0,o.jsx)(b.N,{children:w&&!R&&(0,o.jsx)(C.P.div,{className:"absolute z-10",initial:{scale:.95,opacity:0},animate:{scale:1,opacity:1},transition:{type:"spring",damping:30,stiffness:400,delay:.2},style:{top:d.top+5,left:d.left},children:(0,o.jsx)("div",{className:"border-0.5 flex items-center rounded-lg px-2 pb-1 pt-3 shadow transition bg-bg-000 text-text-400 border-border-300",children:(0,o.jsxs)("div",{className:"-mx-1 -mt-2 flex items-stretch justify-between gap-0.5",children:[(0,o.jsxs)(m.k,{onClick:()=>{q(!0)},isAssistant:!0,children:[(0,o.jsx)(x.f,{size:16}),(0,o.jsx)(S.A,{defaultMessage:"Improve",id:"BATKcMm/a2"})]}),(0,o.jsxs)(m.k,{onClick:()=>{I({prompt:"".concat(r.formatMessage({defaultMessage:"Can you explain this section to me in more detail?",id:"LMDbiRxyDQ"}),"\n\n").concat(L()),attachments:[],files:[],syncSources:[]})},isAssistant:!0,children:[(0,o.jsx)(y.g,{size:16}),(0,o.jsx)(S.A,{defaultMessage:"Explain",id:"HGdgPPM2Ry"})]})]})})})}),(0,o.jsx)(b.N,{children:R&&(0,o.jsxs)(C.P.form,{initial:{opacity:0,y:-10},animate:{opacity:1,y:0},transition:{type:"spring",damping:30,stiffness:400},className:"z-10 absolute flex gap-2 p-2 pl-4 items-center h-12 rounded-lg bg-bg-000 text-text-200 border border-0.5 border-border-300 shadow-xl",style:{top:d.top+5,left:d.left,width:d.width},ref:T,onSubmit:e=>{e.preventDefault(),U()},children:[(0,o.jsx)("input",{type:"text",value:M,onChange:e=>j(e.target.value),placeholder:r.formatMessage({defaultMessage:"Describe what you would like to update...",id:"smio7jldoW"}),className:"py-0.5 px-0 border-0 bg-transparent text-sm grow !shadow-none text-text-200 placeholder-text-500 hide-focus-ring",autoFocus:!0}),(0,o.jsx)(b.N,{children:M.trim().length>0?(0,o.jsx)(C.P.div,{initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.9},transition:{type:"spring",damping:30,stiffness:400,delay:0},children:(0,o.jsx)(g.$,{onClick:()=>U(),"aria-label":r.formatMessage({defaultMessage:"Send Message",id:"yJAKR0Ngpn"}),type:"submit",children:(0,o.jsx)("div",{className:"flex items-center gap-2 select-none",children:(0,o.jsx)(S.A,{defaultMessage:"Update",id:"BWpuKlRSA1"})})})}):null})]})})]})};var R=n(76761);let q=e=>{let{handleClose:t,title:n,description:a,inset:s,action:r}=e;return(0,o.jsxs)("div",{className:"border-border-300 shadow-sm w-[300px] max-w-full bg-bg-000 rounded-xl p-5 border relative",children:[(0,o.jsx)("div",{className:"text-left mb-2 font-medium text-sm",children:n}),(0,o.jsx)("p",{className:"mb-2 text-sm",children:a}),!!s&&(0,o.jsx)("div",{className:"flex flex-col rounded-md bg-text-000 bg-opacity-5 p-4 font-mono text-xs text-text-300",children:s}),r&&(0,o.jsx)("div",{className:"flex justify-end",children:(0,o.jsx)(g.$,{variant:"primary",className:"mt-4 text-sm",onClick:r.onClick,disabled:r.disabled,loading:r.loading,children:r.label})}),(0,o.jsx)("div",{className:"absolute top-2 right-2",children:(0,o.jsx)(g.$,{variant:"ghost",onClick:t,className:"h-9 w-9 !min-w-9",children:(0,o.jsx)(R.X,{})})})]})},M=e=>{var t,n,a;let{error:s,handleClose:r,sendMessage:i,isStreaming:l}=e,[c,d]=(0,p.useState)(!1),u=(0,v.A)(),h=function(e,t){switch(e.type){case"UnsupportedImports":return{title:t?t.formatMessage({defaultMessage:"Artifact failed to load",id:"NcDXiSfIPe"}):"Artifact failed to load",description:t?t.formatMessage({defaultMessage:"The generated artifact uses libraries we don’t support:",id:"HG0Hu8xIQA"}):"The generated artifact uses libraries we don’t support:",inset:[...e.unsupportedModules,...e.nonExistentIcons.map(e=>"{ ".concat(e,' } from "lucide-react"'))],subtext:t?t.formatMessage({defaultMessage:"The code itself may still work. To use it, you’ll need a development setup with these libraries installed.",id:"Et/uvuRBba"}):"The code itself may still work. To use it, you’ll need a development setup with these libraries installed."};case"RuntimeError":return{title:t?t.formatMessage({defaultMessage:"Error running artifact",id:"JU2kK1J3jY"}):"Error running artifact",description:t?t.formatMessage({defaultMessage:"An error occurred while trying to run the generated artifact.",id:"3RpkNRAyPc"}):"An error occurred while trying to run the generated artifact.",inset:[e.message],insetStyle:"danger"};case"FileNotFound":return{title:t?t.formatMessage({defaultMessage:"File not found",id:"gcaJtRf4b0"}):"File not found",description:t?t.formatMessage({defaultMessage:"The file “{fileName}” could not be found.",id:"0kOCGtB3eN"},{fileName:e.fileName}):"The file “".concat(e.fileName,"” could not be found."),subtext:t?t.formatMessage({defaultMessage:"Please check the file name and try again.",id:"/fdYJU5SMC"}):"Please check the file name and try again."};case"ClaudeCompletionError":return{title:t?t.formatMessage({defaultMessage:"Error in Claude completion",id:"ya5HK9oB9T"}):"Error in Claude completion",description:e.message}}}(s.error,u),m="> ".concat(h.description,"\n  ").concat(null!=(a=null==(t=h.inset)?void 0:t.map(e=>"> `".concat(e,"`")).join("\n"))?a:"","\n  \n\n  Can you fix this error in `").concat(s.artifactId,"`?"),g=i?{label:u.formatMessage({defaultMessage:"Try fixing with Claude",id:"wrcoZ2Zo0b"}),onClick:()=>{d(!0),null==i||i({prompt:m,attachments:[],files:[],syncSources:[]})},disabled:l,loading:c}:void 0;return(0,o.jsx)("div",{className:"absolute bottom-5 left-5 right-5",children:(0,o.jsx)(q,{title:h.title,description:h.description,handleClose:r,inset:(null==(n=h.inset)?void 0:n.length)?h.inset?(0,o.jsx)("ul",{children:h.inset.map((e,t)=>(0,o.jsx)("li",{children:e},t))}):null:void 0,action:g})})};var j=n(25323);let E="opacity-30 blur-[2px]",P=e=>{let{isOpen:t,content:n,language:a,citations:s,type:r,showRaw:i,richSandboxRef:d,isCurrentStreaming:h,isChatStreaming:m,onSandboxConfirmation:g,onDOMContentLoaded:f,sendMessage:x,richSandboxCapabilities:y,isLatestVersion:b,artifactId:C,artifactUuid:v,artifactVersion:S,onArtifactRuntimeError:w,artifact:z,hasMenuOpen:R,zoom:q,onTrackInteraction:P}=e,T=void 0!==r&&void 0!==n&&r!==c.vU.Code&&r!==c.vU.Markdown,F=(0,p.useRef)(null),A=T&&!i,[I,L]=(0,p.useState)(null),U=(0,p.useCallback)(e=>{void 0!==C&&void 0!==S&&(void 0!==w&&w(e),L({error:e,artifactId:C,artifactVersion:S}))},[C,S,w]);(0,p.useEffect)(()=>{var e;if(!z||!h)return;let t=z.versions[z.versions.length-1],n=z.versions[z.versions.length-2];if(!n||!t||"update"!==t.command)return;let o=N(n.resultState,t.resultState);-1!==o&&(null==(e=F.current)||e.scrollToPercentage(o/100))},[n,z,h]),(0,p.useEffect)(()=>{!h&&F.current&&F.current.enableScrolling()},[h]);let G=(0,p.useCallback)(()=>{L(e=>e&&(e.artifactId!==C||e.artifactVersion!==S)?null:e)},[C,S]),H=(0,p.useCallback)(()=>{L(null)},[]);return(0,o.jsxs)(o.Fragment,{children:[T&&(0,o.jsxs)("div",{className:(0,u.A)("ease-out duration-200",A?"h-full w-full relative border-none":"absolute opacity-0 w-0 h-0 overflow-hidden pointer-events-none",R&&E),children:[(0,o.jsx)(j.A,{ref:d,className:A?"h-full w-full border-none bg-bg-100":"absolute opacity-0 w-0 h-0 overflow-hidden pointer-events-none",content:A?n:void 0,type:A?r:void 0,onSandboxConfirmation:g,onDOMContentLoaded:f,capabilities:y,onReportError:U,onSetContent:G,onRefresh:H,externalLinkBehavior:"ask",zoom:q,onTrackInteraction:P,artifactUuid:v}),A&&I&&(0,o.jsx)(M,{error:I,handleClose:()=>L(null),sendMessage:b?x:void 0,isStreaming:m})]}),void 0===n||void 0===r?null:r===c.vU.Code||i?(0,o.jsx)(l.Z,{noDefaultScroll:!h,ref:F,className:(0,u.A)("ease-out duration-200","relative flex w-full flex-1 overflow-x-auto overflow-y-scroll",R&&E),children:(0,o.jsx)(k,{content:n,isStreaming:m,language:a,sendMessage:x,isOpen:t},"code-".concat(C,"-").concat(S,"-").concat(h))}):r===c.vU.Markdown?(0,o.jsx)(l.Z,{noDefaultScroll:!h,ref:F,className:(0,u.A)("ease-out duration-200","relative flex w-full flex-1 overflow-x-auto overflow-y-scroll",R&&E),children:(0,o.jsx)(O,{content:n,citations:s,isStreaming:m,sendMessage:x,isOpen:t},"markdown-".concat(C,"-").concat(S,"-").concat(h))}):null]})},k=e=>{let{content:t,isStreaming:n,language:s,sendMessage:r,isOpen:l}=e,{codeStyle:c}=(0,i.V)();return(0,o.jsx)(w,{isStreaming:n,sendMessage:r,contentType:"code",isOpen:l,children:(0,o.jsx)(h.A,{className:"code-block__code !my-0 h-fit min-h-full w-fit min-w-full !rounded-none !text-sm !leading-relaxed",language:s,PreTag:"div",style:c,renderer:a.G,children:t})})},O=e=>{let{content:t,citations:n,isStreaming:a,sendMessage:i,isOpen:l}=e,c=(0,d.n)(),u=(0,p.useMemo)(()=>c&&n&&n.length>0?(0,r.k0)(n,t):t,[t,n,c]);return(0,o.jsx)(w,{isStreaming:a,sendMessage:i,isOpen:l,children:(0,o.jsxs)("div",{tabIndex:0,id:"markdown-artifact",className:"font-claude-message mx-auto w-full max-w-3xl leading-[1.65rem] -tracking-[0.015em] px-6 pt-4 md:pt-6 md:px-11",children:[(0,o.jsx)(s.fP,{text:u,blockCitations:n,className:"!gap-3.5"}),(0,o.jsx)("div",{className:"h-8"})]})})},N=(e,t)=>{if(!e||!t)return -1;let n=e.replace(/\\n/g,"\n"),o=t.replace(/\\n/g,"\n"),a=[...n].findIndex((e,t)=>e!==o[t]);if(-1===a&&n.length===o.length)return -1;let s=(n.slice(0,-1===a?n.length:a).match(/\n/g)||[]).length,r=(n.match(/\n/g)||[]).length;return r?Math.round(s/r*100):-1}},20810:(e,t,n)=>{n.d(t,{_:()=>i});var o=n(21155);let a=new Set(["accept","accept-language","content-type","content-length"]),s=new Set(["set-cookie","x-api-key","x-auth-token","authorization"]),r={"api.anthropic.com":async(e,t)=>await fetch("/api/organizations/".concat(e,"/proxy/v1/messages"),t)};async function i(e,t,n,o){let i,{url:c,method:d,headers:u,body:p,channelId:h}=e,m=new URL(c),g={};for(let[e,t]of Object.entries(u))a.has(e.toLowerCase())&&(g[e]=t);o&&(g["anthropic-artifact-id"]=o);let f=new AbortController;if(m.hostname in r)i=await r[m.hostname](n||"",{method:d,headers:g,body:p||void 0,signal:f.signal,redirect:"manual"});else throw Error("Unable to proxy requests for ".concat(m.hostname,"."));let x={};return i.headers.forEach((e,t)=>{s.has(t.toLowerCase())||(x[t]=e)}),l(i,h,t),{"@type":"type.googleapis.com/anthropic.claude.usercontent.sandbox.ProxyFetchResponse",status:i.status,statusText:i.statusText,headers:x}}async function l(e,t,n){var a;let s=null==(a=e.body)?void 0:a.getReader();if(!s)return void await n(o.uZ.ProxyFetchStream,{"@type":"type.googleapis.com/anthropic.claude.usercontent.sandbox.ProxyFetchStreamRequest",channelId:t,chunk:null,done:!0});let r=0;try{for(;;){let{done:e,value:a}=await s.read();if(e){await n(o.uZ.ProxyFetchStream,{"@type":"type.googleapis.com/anthropic.claude.usercontent.sandbox.ProxyFetchStreamRequest",channelId:t,chunk:null,done:!0});break}if(a){let e;if((r+=a.byteLength)>0xa00000)throw Error("Response body exceeds maximum size of ".concat(0xa00000," bytes"));let s=0===a.byteOffset&&a.byteLength===a.buffer.byteLength?a.buffer:a.buffer.slice(a.byteOffset,a.byteOffset+a.byteLength);e=s instanceof ArrayBuffer?s:new Uint8Array(s).slice().buffer,await n(o.uZ.ProxyFetchStream,{"@type":"type.googleapis.com/anthropic.claude.usercontent.sandbox.ProxyFetchStreamRequest",channelId:t,chunk:e,done:!1},[e])}}}catch(e){await n(o.uZ.ProxyFetchStream,{"@type":"type.googleapis.com/anthropic.claude.usercontent.sandbox.ProxyFetchStreamRequest",channelId:t,chunk:null,done:!1,error:e instanceof Error?e.message:"Unknown error"})}finally{s.releaseLock()}}},21155:(e,t,n)=>{n.d(t,{K_:()=>g,Ub:()=>h,tH:()=>y,uZ:()=>r,v9:()=>x,x8:()=>f,zN:()=>p});var o=n(54890),a=n(75006),s=n(44124),r=function(e){return e.ReadyForContent="anthropic.claude.usercontent.sandbox.ReadyForContent",e.SetContent="anthropic.claude.usercontent.sandbox.SetContent",e.GetFile="anthropic.claude.usercontent.sandbox.GetFile",e.SendConversationMessage="anthropic.claude.usercontent.sandbox.SendConversationMessage",e.RunCode="anthropic.claude.usercontent.sandbox.RunCode",e.ClaudeCompletion="anthropic.claude.usercontent.sandbox.ClaudeCompletion",e.ReportError="anthropic.claude.usercontent.sandbox.ReportError",e.GetScreenshot="anthropic.claude.usercontent.sandbox.GetScreenshot",e.BroadcastContentSize="anthropic.claude.usercontent.sandbox.BroadcastContentSize",e.OpenExternal="anthropic.claude.usercontent.sandbox.OpenExternal",e.CopyHtmlContent="anthropic.claude.usercontent.sandbox.CopyHtmlContent",e.TrackInteraction="anthropic.claude.usercontent.sandbox.TrackInteraction",e.ProxyFetch="anthropic.claude.usercontent.sandbox.ProxyFetch",e.ProxyFetchStream="anthropic.claude.usercontent.sandbox.ProxyFetchStream",e.GetDOMSnapshot="anthropic.claude.usercontent.sandbox.GetDOMSnapshot",e.DOMContentLoaded="anthropic.claude.usercontent.sandbox.DOMContentLoaded",e}({});let i=a.z.object({type:a.z.literal("UnsupportedImports"),unsupportedModules:a.z.array(a.z.string()),nonExistentIcons:a.z.array(a.z.string())}),l=a.z.object({type:a.z.literal("RuntimeError"),message:a.z.string()}),c=a.z.object({type:a.z.literal("FileNotFound"),fileName:a.z.string()}),d=a.z.object({type:a.z.literal("ClaudeCompletionError"),message:a.z.string()}),u=a.z.discriminatedUnion("type",[i,l,c,d]),p=a.z.object({code:a.z.string()}),h=a.z.object({status:a.z.enum(["success","error"]),result:a.z.string().optional(),logs:a.z.array(a.z.string()),error:a.z.string().optional()}),m={"anthropic.claude.usercontent.sandbox.CopyHtmlContent":{requestSchema:s.Uq.extend({method:a.z.literal("anthropic.claude.usercontent.sandbox.CopyHtmlContent"),payload:a.z.strictObject({"@type":a.z.literal("type.googleapis.com/anthropic.claude.usercontent.sandbox.CopyHtmlContentRequest")})}),responseSchema:s.Ko.extend({payload:a.z.strictObject({"@type":a.z.literal("type.googleapis.com/anthropic.claude.usercontent.sandbox.CopyHtmlContentResponse"),reportHTMLContent:a.z.string()})}),alwaysPermitted:!1},"anthropic.claude.usercontent.sandbox.SetContent":{requestSchema:s.Uq.extend({method:a.z.literal("anthropic.claude.usercontent.sandbox.SetContent"),payload:a.z.strictObject({"@type":a.z.literal("type.googleapis.com/anthropic.claude.usercontent.sandbox.SandboxContent"),content:a.z.string(),type:a.z.nativeEnum(o.vU),watchContentSize:a.z.boolean().optional()})}),responseSchema:s.gq,alwaysPermitted:!1},"anthropic.claude.usercontent.sandbox.ReadyForContent":{requestSchema:s.Uq.extend({method:a.z.literal("anthropic.claude.usercontent.sandbox.ReadyForContent"),payload:a.z.strictObject({"@type":a.z.literal("type.googleapis.com/google.protobuf.Empty")})}),responseSchema:s.gq,alwaysPermitted:!0},"anthropic.claude.usercontent.sandbox.BroadcastContentSize":{requestSchema:s.Uq.extend({method:a.z.literal("anthropic.claude.usercontent.sandbox.BroadcastContentSize"),payload:a.z.strictObject({"@type":a.z.literal("type.googleapis.com/anthropic.claude.usercontent.sandbox.BroadcastContentSizePayload"),height:a.z.number(),width:a.z.number()})}),responseSchema:s.gq,alwaysPermitted:!1},"anthropic.claude.usercontent.sandbox.GetFile":{requestSchema:s.Uq.extend({method:a.z.literal("anthropic.claude.usercontent.sandbox.GetFile"),payload:a.z.strictObject({key:a.z.string(),"@type":a.z.literal("type.googleapis.com/anthropic.claude.usercontent.sandbox.GetFileRequest")})}),responseSchema:s.Ko.extend({payload:a.z.strictObject({value:a.z.instanceof(Uint8Array).nullable(),"@type":a.z.literal("type.googleapis.com/anthropic.claude.usercontent.sandbox.GetFileResponse")})}),alwaysPermitted:!1},"anthropic.claude.usercontent.sandbox.SendConversationMessage":{requestSchema:s.Uq.extend({method:a.z.literal("anthropic.claude.usercontent.sandbox.SendConversationMessage"),payload:a.z.strictObject({message:a.z.string(),messageType:a.z.enum(["text","error"]),"@type":a.z.literal("type.googleapis.com/anthropic.claude.usercontent.sandbox.SendConversationMessageRequest")})}),responseSchema:s.gq,alwaysPermitted:!1},"anthropic.claude.usercontent.sandbox.RunCode":{requestSchema:s.Uq.extend({method:a.z.literal("anthropic.claude.usercontent.sandbox.RunCode"),payload:a.z.strictObject({code:a.z.string(),"@type":a.z.literal("type.googleapis.com/anthropic.claude.usercontent.sandbox.RunCodeRequest")})}),responseSchema:s.Ko.extend({payload:a.z.strictObject({"@type":a.z.literal("type.googleapis.com/anthropic.claude.usercontent.sandbox.RunCodeResponse")}).merge(h)}),alwaysPermitted:!1},"anthropic.claude.usercontent.sandbox.ClaudeCompletion":{requestSchema:s.Uq.extend({method:a.z.literal("anthropic.claude.usercontent.sandbox.ClaudeCompletion"),payload:a.z.strictObject({prompt:a.z.string(),"@type":a.z.literal("type.googleapis.com/anthropic.claude.usercontent.sandbox.ClaudeCompletionRequest")})}),responseSchema:s.Ko.extend({payload:a.z.strictObject({completion:a.z.string().nullable(),"@type":a.z.literal("type.googleapis.com/anthropic.claude.usercontent.sandbox.ClaudeCompletionResponse")})}),alwaysPermitted:!1},"anthropic.claude.usercontent.sandbox.ReportError":{requestSchema:s.Uq.extend({method:a.z.literal("anthropic.claude.usercontent.sandbox.ReportError"),payload:a.z.strictObject({"@type":a.z.literal("type.googleapis.com/anthropic.claude.usercontent.sandbox.ReportErrorRequest"),error:u})}),responseSchema:s.gq,alwaysPermitted:!0},"anthropic.claude.usercontent.sandbox.GetScreenshot":{requestSchema:s.Uq.extend({method:a.z.literal("anthropic.claude.usercontent.sandbox.GetScreenshot"),payload:a.z.strictObject({"@type":a.z.literal("type.googleapis.com/google.protobuf.Empty")})}),responseSchema:s.Ko.extend({payload:a.z.strictObject({screenshot:a.z.string().nullable(),"@type":a.z.literal("type.googleapis.com/anthropic.claude.usercontent.sandbox.GetScreenshotResponse")})}),alwaysPermitted:!1},"anthropic.claude.usercontent.sandbox.OpenExternal":{requestSchema:s.Uq.extend({method:a.z.literal("anthropic.claude.usercontent.sandbox.OpenExternal"),payload:a.z.strictObject({"@type":a.z.literal("type.googleapis.com/anthropic.claude.usercontent.sandbox.OpenExternal"),href:a.z.string()})}),responseSchema:s.gq,alwaysPermitted:!0},"anthropic.claude.usercontent.sandbox.TrackInteraction":{requestSchema:s.Uq.extend({method:a.z.literal("anthropic.claude.usercontent.sandbox.TrackInteraction"),payload:a.z.strictObject({"@type":a.z.literal("type.googleapis.com/anthropic.claude.usercontent.sandbox.TrackInteraction"),interactionType:a.z.literal("click")})}),responseSchema:s.gq,alwaysPermitted:!0},"anthropic.claude.usercontent.sandbox.ProxyFetch":{requestSchema:s.Uq.extend({method:a.z.literal("anthropic.claude.usercontent.sandbox.ProxyFetch"),payload:a.z.strictObject({"@type":a.z.literal("type.googleapis.com/anthropic.claude.usercontent.sandbox.ProxyFetchRequest"),url:a.z.string(),method:a.z.string(),headers:a.z.record(a.z.string()),body:a.z.instanceof(ArrayBuffer).nullable(),channelId:a.z.string()})}),responseSchema:s.Ko.extend({payload:a.z.strictObject({"@type":a.z.literal("type.googleapis.com/anthropic.claude.usercontent.sandbox.ProxyFetchResponse"),status:a.z.number(),statusText:a.z.string(),headers:a.z.record(a.z.string())})}),alwaysPermitted:!1},"anthropic.claude.usercontent.sandbox.ProxyFetchStream":{requestSchema:s.Uq.extend({method:a.z.literal("anthropic.claude.usercontent.sandbox.ProxyFetchStream"),payload:a.z.strictObject({"@type":a.z.literal("type.googleapis.com/anthropic.claude.usercontent.sandbox.ProxyFetchStreamRequest"),channelId:a.z.string(),chunk:a.z.instanceof(ArrayBuffer).nullable(),done:a.z.boolean(),error:a.z.string().optional()})}),responseSchema:s.gq,alwaysPermitted:!1},"anthropic.claude.usercontent.sandbox.GetDOMSnapshot":{requestSchema:s.Uq.extend({method:a.z.literal("anthropic.claude.usercontent.sandbox.GetDOMSnapshot"),payload:a.z.strictObject({"@type":a.z.literal("type.googleapis.com/google.protobuf.Empty")})}),responseSchema:s.Ko.extend({payload:a.z.strictObject({"@type":a.z.literal("type.googleapis.com/anthropic.claude.usercontent.sandbox.GetDOMSnapshotResponse"),domSnapshot:a.z.string().nullable()})}),alwaysPermitted:!1},"anthropic.claude.usercontent.sandbox.DOMContentLoaded":{requestSchema:s.Uq.extend({method:a.z.literal("anthropic.claude.usercontent.sandbox.DOMContentLoaded"),payload:a.z.strictObject({"@type":a.z.literal("type.googleapis.com/google.protobuf.Empty")})}),responseSchema:s.gq,alwaysPermitted:!0}},g=a.z.enum(["anthropic.claude.usercontent.sandbox.ReadyForContent","anthropic.claude.usercontent.sandbox.GetFile","anthropic.claude.usercontent.sandbox.SendConversationMessage","anthropic.claude.usercontent.sandbox.ClaudeCompletion","anthropic.claude.usercontent.sandbox.ReportError","anthropic.claude.usercontent.sandbox.BroadcastContentSize","anthropic.claude.usercontent.sandbox.OpenExternal","anthropic.claude.usercontent.sandbox.TrackInteraction","anthropic.claude.usercontent.sandbox.ProxyFetch","anthropic.claude.usercontent.sandbox.DOMContentLoaded"]),f=a.z.discriminatedUnion("method",[m["anthropic.claude.usercontent.sandbox.ReadyForContent"].requestSchema,m["anthropic.claude.usercontent.sandbox.GetFile"].requestSchema,m["anthropic.claude.usercontent.sandbox.SendConversationMessage"].requestSchema,m["anthropic.claude.usercontent.sandbox.ClaudeCompletion"].requestSchema,m["anthropic.claude.usercontent.sandbox.ReportError"].requestSchema,m["anthropic.claude.usercontent.sandbox.BroadcastContentSize"].requestSchema,m["anthropic.claude.usercontent.sandbox.OpenExternal"].requestSchema,m["anthropic.claude.usercontent.sandbox.TrackInteraction"].requestSchema,m["anthropic.claude.usercontent.sandbox.ProxyFetch"].requestSchema,m["anthropic.claude.usercontent.sandbox.DOMContentLoaded"].requestSchema]);a.z.union([s.gq,m["anthropic.claude.usercontent.sandbox.GetFile"].responseSchema,m["anthropic.claude.usercontent.sandbox.SendConversationMessage"].responseSchema,m["anthropic.claude.usercontent.sandbox.ClaudeCompletion"].responseSchema,m["anthropic.claude.usercontent.sandbox.ProxyFetch"].responseSchema]),a.z.enum(["anthropic.claude.usercontent.sandbox.SetContent","anthropic.claude.usercontent.sandbox.RunCode","anthropic.claude.usercontent.sandbox.GetScreenshot","anthropic.claude.usercontent.sandbox.CopyHtmlContent","anthropic.claude.usercontent.sandbox.ProxyFetchStream","anthropic.claude.usercontent.sandbox.GetDOMSnapshot"]),a.z.discriminatedUnion("method",[m["anthropic.claude.usercontent.sandbox.SetContent"].requestSchema,m["anthropic.claude.usercontent.sandbox.RunCode"].requestSchema,m["anthropic.claude.usercontent.sandbox.GetScreenshot"].requestSchema,m["anthropic.claude.usercontent.sandbox.CopyHtmlContent"].requestSchema,m["anthropic.claude.usercontent.sandbox.ProxyFetchStream"].requestSchema,m["anthropic.claude.usercontent.sandbox.GetDOMSnapshot"].requestSchema]);let x=a.z.union([m["anthropic.claude.usercontent.sandbox.SetContent"].responseSchema,m["anthropic.claude.usercontent.sandbox.RunCode"].responseSchema,m["anthropic.claude.usercontent.sandbox.GetScreenshot"].responseSchema,m["anthropic.claude.usercontent.sandbox.CopyHtmlContent"].responseSchema,m["anthropic.claude.usercontent.sandbox.ProxyFetchStream"].responseSchema,m["anthropic.claude.usercontent.sandbox.GetDOMSnapshot"].responseSchema]),y=Object.entries(m).filter(e=>{let[t,n]=e;return!0===n.alwaysPermitted}).map(e=>{let[t,n]=e;return t})},25323:(e,t,n)=>{n.d(t,{A:()=>C});var o=n(54568),a=n(94649),s=n(10158),r=n(1761),i=n(41417),l=n(27062),c=n(70825),d=n(32987),u=n(49645),p=n(37463),h=n(7620),m=n(46760),g=n(62971),f=n(21155),x=n(20810),y=n(44124),b=n(53120);let C=(0,h.forwardRef)((e,t)=>{let{content:n,className:C,type:v,onSandboxConfirmation:S,onDOMContentLoaded:w,capabilities:z,onReportError:R,onSetContent:q,onRefresh:M,externalLinkBehavior:j,onOpenExternalLinkRequest:E,onTrackInteraction:P,lazy:k=!0,zoom:O=1,artifactUuid:N}=e,T=(0,m.A)(),{userContentRendererUrl:F}=(0,s._r)(),[A,I]=(0,h.useState)(!1),L=(0,h.useRef)(null),[U,G]=(0,h.useState)(null),{activeOrganization:H}=(0,r.YL)(),{value:D}=(0,l.fS)("apps_use_turmeric"),[_,Z]=(0,h.useState)(0),B=e=>e>=100,{sendRequest:K,updatePermission:W}=function(e){let{iframeRef:t,allowedOrigin:n,onRateLimited:o=null,initialPermissions:a,onPermissionRequested:s,onCapabilityAction:r}=e,[i,l]=(0,h.useState)(null),c=(0,h.useRef)(a),[d,u]=(0,h.useState)(0);(0,h.useEffect)(()=>{if(!t.current&&d<20){let e=setTimeout(()=>{u(e=>e+1)},500);return()=>clearTimeout(e)}if(!t.current)return void console.warn("Max retries reached while waiting for iframe");let e=new b.x({iframe:t.current,allowedOrigin:n,onRateLimited:o,onPermissionRequested:async e=>{if(f.tH.includes(e)||"accepted"===c.current[e])return"accepted";let t=await s(e);return c.current={...c.current,[e]:t},t},onCapabilityAction:r});return l(e),()=>{e.cleanup()}},[t,n,c,o,s,r,d]);let p=(0,h.useCallback)(async(e,t)=>{if(i)return i.sendRequest(e,t);throw Error("Communicator not initialized")},[i]),m=(0,h.useCallback)(()=>{null==i||i.restartListening()},[i]),g=(0,h.useCallback)((e,t)=>{c.current={...c.current,[e]:t}},[]);return{sendRequest:null===i?void 0:p,restartListening:m,permissions:c.current,updatePermission:g}}({iframeRef:L,allowedOrigin:F,onCapabilityAction:(0,h.useCallback)(async(e,t)=>{if(e.method===f.uZ.ReadyForContent)return I(!0),null==S||S(),Promise.resolve();if(e.method===f.uZ.GetFile)return z&&z.getFile?Promise.resolve({"@type":"type.googleapis.com/anthropic.claude.usercontent.sandbox.GetFileResponse",value:await z.getFile(e.payload.key)}):Promise.reject();if(e.method===f.uZ.SendConversationMessage)return z&&z.sendMessage?(await z.sendMessage({prompt:e.payload.message,attachments:[],files:[],syncSources:[]}),Promise.resolve()):Promise.reject();if(e.method===f.uZ.ClaudeCompletion)return z&&z.claudeComplete?(Z(e=>e+1),Promise.resolve({"@type":"type.googleapis.com/anthropic.claude.usercontent.sandbox.ClaudeCompletionResponse",completion:await z.claudeComplete(e.payload.prompt)})):Promise.reject();if(e.method===f.uZ.BroadcastContentSize);else if(e.method===f.uZ.DOMContentLoaded)return null==w||w(),Promise.resolve();else if(e.method===f.uZ.OpenExternal){if("ask"===j)return G(e.payload.href),Promise.resolve();if("bubble"===j&&E)return E({href:e.payload.href}),Promise.resolve()}else if(e.method===f.uZ.ReportError)return null==R||R(e.payload.error),Promise.resolve();else if(e.method===f.uZ.TrackInteraction)return null==P||P(e.payload),Promise.resolve();else if(e.method===f.uZ.ProxyFetch)return(0,x._)(e.payload,t,null==H?void 0:H.uuid,N);return Promise.reject()},[S,w,z,I,R,Z,j,E,P,null==H?void 0:H.uuid,N]),onPermissionRequested:(0,h.useCallback)(async e=>e===f.uZ.ClaudeCompletion&&B(_)?"denied":Promise.resolve("accepted"),[_]),initialPermissions:{}});(0,h.useEffect)(()=>{B(_)&&(W(f.uZ.ClaudeCompletion,"denied"),(0,c.wd)("Claude completion request limit hit."))},[_,W]);let V=(0,h.useCallback)(()=>{(0,c.wd)("Claude completion modal confirmed"),Z(0),W(f.uZ.ClaudeCompletion,"accepted")},[W]),J=(0,h.useCallback)(async()=>{let e=await (null==K?void 0:K(f.uZ.GetScreenshot,y.qs));if(null==e?void 0:e.screenshot){if(e.screenshot.length>0xa00000)throw Error(T.formatMessage({defaultMessage:"Screenshot too large",id:"ifBuzEbIz2"}));if(!/^data:image\/(png|jpeg|gif);base64,/.test(e.screenshot))throw Error(T.formatMessage({defaultMessage:"Invalid screenshot format",id:"KCmGxpLNuq"}));return e.screenshot}},[T,K]),Q=(0,h.useCallback)(async()=>{let e=await (null==K?void 0:K(f.uZ.CopyHtmlContent,{"@type":"type.googleapis.com/anthropic.claude.usercontent.sandbox.CopyHtmlContentRequest"}));return null==e?void 0:e.reportHTMLContent},[K]),X=(0,h.useCallback)(async()=>{let e=await (null==K?void 0:K(f.uZ.GetDOMSnapshot,y.qs));return(null==e?void 0:e.domSnapshot)||void 0},[K]);return(0,h.useEffect)(()=>{A&&n&&v&&(null==q||q(),null==K||K(f.uZ.SetContent,{content:n,type:v,"@type":"type.googleapis.com/anthropic.claude.usercontent.sandbox.SandboxContent"}))},[n,K,v,A,q]),(0,h.useImperativeHandle)(t,()=>({refresh:()=>{null==M||M(),I(!1);let e=L.current;e&&(e.src="".concat(F).concat(R?"?errorReportingMode=parent":""))},getScreenshot:J,copyHtmlContent:Q,getDOMSnapshot:X})),(0,o.jsxs)("div",{className:(0,d.A)("relative",C),children:[(0,o.jsx)("iframe",{ref:L,className:"h-full w-full",style:{zoom:O},sandbox:"allow-scripts allow-same-origin",title:T.formatMessage({defaultMessage:"Claude content",id:"/Ma3teJf9/"}),loading:k?"lazy":void 0,src:"".concat(F).concat(R?"?errorReportingMode=parent":""),allow:"fullscreen; clipboard-write"}),(0,o.jsx)(u.N,{children:!A&&(0,o.jsx)(p.P.div,{className:"bg-bg-100 absolute inset-0 z-10",initial:{opacity:1},animate:{opacity:1},exit:{opacity:0},transition:{duration:.15,ease:"easeInOut"}})}),U?(0,o.jsx)(a.v,{isOpen:!!U,url:U,onClose:()=>G(null),onConfirm:()=>{U&&window.open(U,"_blank"),G(null)}}):null,D&&B(_)&&(0,o.jsx)("div",{className:"fixed inset-0 bg-always-black bg-opacity-50 flex items-center justify-center z-modal",children:(0,o.jsxs)("div",{className:"bg-bg-100 p-4 rounded shadow-lg",children:[(0,o.jsx)("p",{className:"text-fg-100 mb-4",children:(0,o.jsx)(g.A,{defaultMessage:"Many requests made. Acknowledge that you’re still here to continue.",id:"kmh/1AmVcl"})}),(0,o.jsx)(i.$,{onClick:V,variant:"primary",children:(0,o.jsx)(g.A,{defaultMessage:"I’m still here",id:"NwhjMfjigc"})})]})})]})});C.displayName="RichSandbox"},44124:(e,t,n)=>{n.d(t,{Ko:()=>r,SV:()=>d,Uq:()=>s,_s:()=>a,gq:()=>l,qs:()=>c,t6:()=>i});var o=n(75006);let a=o.z.object({channel:o.z.enum(["request","response"]),requestId:o.z.string()}).passthrough(),s=a.strict().extend({channel:o.z.literal("request"),method:o.z.string(),payload:o.z.strictObject({"@type":o.z.string()})}),r=a.extend({channel:o.z.literal("response"),status:o.z.number().int().min(100).max(599),payload:o.z.strictObject({"@type":o.z.string()}).passthrough()}).passthrough(),i=r.extend({status:o.z.number().int().min(400).max(599),payload:o.z.strictObject({"@type":o.z.literal("type.googleapis.com/anthropic.claude.usercontent.ErrorResponse"),error:o.z.string()})}),l=r.extend({payload:o.z.strictObject({"@type":o.z.literal("type.googleapis.com/google.protobuf.Empty")})}),c={"@type":"type.googleapis.com/google.protobuf.Empty"},d=e=>({"@type":"type.googleapis.com/anthropic.claude.usercontent.ErrorResponse",error:e})},47546:(e,t,n)=>{n.d(t,{k:()=>r});var o=n(54568),a=n(29242),s=n(32987);function r(e){let{Icon:t,children:n,isAssistant:r=!0,tooltipContent:i,...l}=e;return(0,o.jsx)(a.m,{className:"mt-1",side:"bottom",delayDuration:100,tooltipContent:i,children:(0,o.jsxs)("button",{...l,className:(0,s.A)("flex flex-row items-center gap-1.5 rounded-md p-2 text-sm transition text-text-300 active:scale-95","select-auto",r?"hover:bg-bg-300 py-1.5":"hover:bg-bg-500 py-1",l.className),children:[t&&(0,o.jsx)(t,{size:16}),n]})})}n(7620)},53120:(e,t,n)=>{n.d(t,{x:()=>r});var o=n(21155),a=n(44124);let s=new Map;class r{setupMessageListener(){window.addEventListener("message",this.boundHandleMessage,!1)}handleMessage(e){if(e.origin!==this.allowedOrigin||e.source!==this.iframe.contentWindow)return;let t=Date.now();if(t-this.lastResetTime>this.RESET_INTERVAL&&(this.messageCount=0,this.lastResetTime=t),this.messageCount++,this.messageCount>this.MAX_MESSAGES_PER_INTERVAL){window.removeEventListener("message",this.boundHandleMessage),this.onRateLimited&&this.onRateLimited();return}let n=a._s.safeParse(e.data);if(!n.success)return void console.warn("Received message does not conform to basic message shape, ignoring");let o=n.data;if("response"===o.channel)return void this.handleResponse(o);this.messageQueue.push(o),this.isConsumerRunning||this.consumeMessages()}handleResponse(e){let t=this.inFlightRequests.get(e.requestId)||s.get(e.requestId);if(void 0!==t){t(e),s.delete(e.requestId);return}}async consumeMessages(){for(this.isConsumerRunning=!0;this.messageQueue.length>0;){let e=this.messageQueue.shift();if(!e)continue;let t=o.K_.safeParse(e.method);if(!t.success){this.sendErrorResponse(e.requestId,400,"Unknown method");continue}let n=t.data,s=o.x8.safeParse(e);if(!s.success){this.sendErrorResponse(e.requestId,400,"Invalid payload content");continue}let r=s.data;if(this.requestLog.has(r.requestId)){this.sendErrorResponse(r.requestId,400,"Request ID already processed");continue}this.requestLog.set(r.requestId,{message:r,requestTimestamp:new Date().getTime()}),await this.onPermissionRequested(n).then(e=>"denied"!==e||(this.sendErrorResponse(r.requestId,403,"Permission denied"),!1)).catch(e=>(console.error("Error checking permission for method ".concat(n,":"),e),this.sendErrorResponse(r.requestId,500,"Error checking permission"),!1))&&(this.onCapabilityAction(r,this.boundSendRequest).then(e=>{var t;let n=a.Ko.parse({channel:"response",status:200,requestId:r.requestId,payload:null!=e?e:a.qs}),o=this.requestLog.get(r.requestId);o&&this.requestLog.set(r.requestId,{...o,response:n,responseTimestamp:new Date().getTime()}),null==(t=this.iframe.contentWindow)||t.postMessage(n,this.allowedOrigin)}).catch(e=>{console.error("Error processing action for method ".concat(n,":"),e),this.sendErrorResponse(r.requestId,500,"Internal server error while processing action")}),await new Promise(e=>requestAnimationFrame(e)))}this.isConsumerRunning=!1}sendErrorResponse(e,t,n){var o;let s=a.t6.parse({channel:"response",status:t,requestId:e,payload:(0,a.SV)(n)}),r=this.requestLog.get(e);r&&this.requestLog.set(e,{...r,response:s,responseTimestamp:new Date().getTime()}),null==(o=this.iframe.contentWindow)||o.postMessage(s,this.allowedOrigin)}restartListening(){window.removeEventListener("message",this.boundHandleMessage),this.messageCount=0,this.lastResetTime=Date.now(),this.setupMessageListener()}cleanup(){window.removeEventListener("message",this.boundHandleMessage),this.messageQueue=[],this.isConsumerRunning=!1,this.inFlightRequests.clear()}async sendRequest(e,t,n){return new Promise((r,i)=>{var l,c;let d=Date.now().toString(),u={channel:"request",method:e,requestId:d,payload:t},p=e=>{let t=a.Ko.safeParse(e);if(!t.success)return void i(Error("Invalid response format"));let n=t.data;if(n.status>=400){let e=a.t6.safeParse(n);e.success?i(Error(e.data.payload.error)):i(Error("Error response (".concat(n.status,")")));return}let s=o.v9.safeParse(n);s.success?r(s.data.payload):i(Error("Invalid response payload for the method"))};this.inFlightRequests.set(d,p),s.set(d,p),n&&n.length>0?null==(l=this.iframe.contentWindow)||l.postMessage(u,this.allowedOrigin,n):null==(c=this.iframe.contentWindow)||c.postMessage(u,this.allowedOrigin)})}getRequestLog(){return Array.from(this.requestLog.entries()).map(e=>{let[t,n]=e;return{...n,requestId:t}}).sort((e,t)=>t.requestTimestamp-e.requestTimestamp)}constructor({iframe:e,allowedOrigin:t,onRateLimited:n=null,onPermissionRequested:o,onCapabilityAction:a}){this.messageCount=0,this.lastResetTime=Date.now(),this.MAX_MESSAGES_PER_INTERVAL=30,this.RESET_INTERVAL=5e3,this.onRateLimited=null,this.messageQueue=[],this.isConsumerRunning=!1,this.requestLog=new Map,this.inFlightRequests=new Map,this.iframe=e,this.allowedOrigin=t,this.onRateLimited=n,this.onPermissionRequested=o,this.onCapabilityAction=a,this.boundHandleMessage=this.handleMessage.bind(this),this.boundSendRequest=this.sendRequest.bind(this),this.setupMessageListener()}}}}]);